<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Demo</title>
  <script src="js\aliyun-sdk.min.js"></script>
  <script src="js\vod-sdk-upload-1.0.6.min.js"></script>
  <script src="js\jquery-1.10.2.min.js"></script>
  <link type="text/css" rel="stylesheet" href="css\button.css" />
  <style>
    tr {
      line-height: 50px;
    }

    input {
      height: 30px;
      border-radius: 5px;
      
      padding: 0 10px;
    }
    input,select,textarea{
      border: 1px solid #bfcbd9;
    }
    input:hover,select:hover,textarea:hover{
      border-color: #8391a5; 
    }
    input:focus,select:focus,textarea:focus{
      border-color: #20a0ff;
      outline:0;
    }
    textarea {
      padding: 5px 10px;
      border-radius: 5px;
    }

    select {
      padding: 8px 20px;
      border-radius: 5px;
    }

    hr {
      color: #ccc;
    }

    .title {
      width: 100px;
      text-align: right;
      padding-right: 20px;
    }

    .body-color {
      z-index: 9998;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      opacity: 0.4;
      filter: alpha(opacity=40);
      display: none
    }

    .hide-body {
      z-index: 9999;
      position: fixed;
      top: 20%;
      left: 25%;
      width: 500px;
      border-radius: 5px;
      border: solid 2px #666;
      background-color: #fff;
      display: none;
      box-shadow: 0 0 10px #666;
    }

    .popup-body ul {
      list-style: none;
    }

    .close-window {
      border-bottom: 1px solid #ddd;
      padding: 0 22px;
      position: relative;
    }

    .bottom {
      padding: 20px;
      text-align: right;
    }

    .close-window .close {
      float: right;
      color: #999;
      padding: 5px;
      margin: -2px -5px -5px;
      font: bold 14px/14px simsun;
      text-shadow: 0 1px 0 #ddd;
    }

    .close-window .close:hover {
      color: #f00;
    }

    .a-upload {
      width: 190px;
      position: relative;
    }

    .a-upload input {
      position: absolute;
      right: 0;
      top: 0;
      opacity: 0;
      filter: alpha(opacity=0);
      cursor: pointer;
    }

    .progress {
      width: 600px;
      height: 5px;
      margin: 10px;
      background: #ccc;
      border-radius: 3px;
      position: relative;
      overflow: hidden;
      display: none;
    }

    #progress-now {
      position: absolute;
      left: 0;
      right: 100%;
      top: 0;
      bottom: 0;
      background: green;
    }
    .labelName{
      width: 120px;
      text-align: right;
    }
    .updataBtn{
      padding: 10px 15px;
      border-radius: 4px;
      background-color: #13ce66;
      display: inline-block;
      color: #fff;
      border: 0;
      cursor: pointer;
    }
    .updataBtn:hover{
      background: #42d885;
    }
    .fileBtn{
      position:relative;
      width: 120px;
      border:1px solid #c2e7b0;
      text-align: center;
      line-height: 28px;
      border-radius: 4px;
      display: inline-block;
      padding: 4px 0;
      color: #67c23a;
      background: #f0f9eb;
      text-decoration:none;
      font-size: 14px;
    }
    .fileBtn:hover{
      color: #fff;
      background: #67c23a;
      border-color: #67c23a;
    }
  </style>
</head>

<body>
  <table frame=void>
    <tr>
      <td class="title">标题:</td>
      <td><input type="text" id="ud_title" size="20" value=""></td>
    </tr>
    <tr>
      <td class="title">描述</td>
      <td><textarea type="text" id="ud_des" rows="5" cols="40"></textarea></td>
    </tr>
    <tr>
      <td class="title">类别:</td>
      <td><select id="ud_cate"></select></td>
    </tr>
    <tr>
      <td class="title">年级:</td>
      <td><select id="ud_grade"></select></td>
    </tr>
    <tr>
      <td class="title">关键词:</td>
      <td><input type="text" id="ud_tag" size="20" value=""></td>
    </tr>
    <tr>
      <td class="title">选择文件:</td>
      <td>
        <a href="javascript:;" class="fileBtn a-upload">
          选择文件
          <input type="file" name="file" id="ud_file"  />
        </a>
      </td>
    </tr>
    <tr>
        <td class="labelName"></td>
      <td><button type="button" onclick="start()" class="updataBtn">开始上传</button></td>
      <td><span style="margin-left:30px;" id="progress-text"></span></td>
    </tr>
  </table>
  <div class="progress">
    <div id="progress-now"></div>
  </div>
  <!-- <select multiple="multiple" id="textarea" style="position:relative; width:620px; height:170px; vertical-align:top; border:1px solid #cccccc;"></select> -->

  <div class="hide-body">
    <div class="close-window">
      <!-- 关闭窗口，也就是触发关闭div的事件-->
      <a href="javascript:;" title="关闭" class="close">×</a>
      <h3>视频上传成功</h3>
    </div>
    <div class="popup-body">
      <ul>
        <li>
          <h4>视频信息</h4>
        </li>
        <li>文件名：<span id="ov_name"></span></li>
        <li>标题：<span id="ov_title"></span></li>
        <li>描述：<span id="ov_des"></span></li>
      </ul>
    </div>
    <div class="bottom">
      <hr>
      <td><button type="button" onclick="toHome()" class="updataBtn">返回主页</button></td>
    </div>
  </div>

  <div class="body-color"></div>

  <script>
    var uploader;
    var uploadAuth;
    var uploadAddress;
    window.onload = new function () {
      uploader = new VODUpload({
        // 文件上传失败
        'onUploadFailed': function (uploadInfo, code, message) {
          $("#progress-text").text('上传失败！');
        },
        // 文件上传完成
        'onUploadSucceed': function (uploadInfo) {
          $("#progress-text").text('上传成功！');
          showPopup(uploadInfo)
        },
        // 文件上传进度
        'onUploadProgress': function (uploadInfo, totalSize, uploadedSize) {
          refreshProgress(Math.ceil(uploadedSize * 100 / totalSize));
          $("#progress-text").text('正在上传中...');
        },
        // 开始上传
        'onUploadstarted': function (uploadInfo) {
          uploader.setUploadAuthAndAddress(uploadInfo, uploadAuth, uploadAddress);
        }
      });
      uploader.init();
      getGradeList();
      getCourseList();
    };

    document.getElementById("ud_file")
      .addEventListener('change', function (event) {
        var userData = '{"Vod":{"UserData":"{"IsShowWaterMark":"false","Priority":"7"}"}}';
        for (var i = 0; i < event.target.files.length; i++) {
          $("#progress-text").text("添加文件: " + event.target.files[i].name);
          uploader.addFile(event.target.files[i], null, null, null, userData);
        }
      });

    var textarea = document.getElementById("textarea");

    function start() {
      $('.progress')[0].style.display = 'block';
      getUpdateAuth()
    }

    function getUpdateAuth() {
      var f = document.getElementById("ud_file");
      if (!$("#ud_title").val()) {
        alert('标题不能为空');
      } else if (!$("#ud_des").val()) {
        alert('描述不能为空');
      } else {
        var ud_title = $("#ud_title").val();
        var ud_des = $("#ud_des").val();
      }
      var ud_cate = $("#ud_cate").val();
      var ud_grade = $("#ud_grade").val();
      var ud_tag = $("#ud_tag").val()
      if (f.files.length == 0) {
        alert('必须先选择文件');
        return;
      }
      $.ajax({
        type: "POST",
        url: "/api/Video/GetVideoUploadAuth",
        contentType: "application/json;charset=utf-8",
        dataType: "json",
        xhrFields: {
          withCredentials: true
        },
        data: JSON.stringify({
          FileName: f.files[0].name,
          FileSize: f.files[0].size,
          Title: ud_title,
          Description: ud_des,
          CateId: ud_cate,
          Grade: ud_grade,
          Tags: ud_tag,
        }),
        success: function (result) {
          uploadAuth = result.Content.UploadAuth
          uploadAddress = result.Content.UploadAddress
          $("#ov_title").text(ud_title)
          $("#ov_des").text(ud_des)
          startUpload()
        }
      });
    }

    function startUpload() {
      if (!uploadAuth || !uploadAddress) {
        alert('请先获取上传授权');
        getUpdateAuth()
        return;
      }
      uploader.startUpload();
    }

    function refreshProgress(n) {
      $('#progress-now').css({
        right: (100 - n) + '%'
      })
    }

    function stop() {
      uploader.stopUpload();
    }

    function resumeWithToken() {
      uploader.resumeUploadWithAuth(uploadAuth);

    }

    function clearList() {
      uploader.cleanList();
    }

    jQuery(document).ready(function ($) {
      $('.close-window .close').click(function () {
        closePopup()
      })
    })

    function closePopup() {
      $('.body-color').fadeOut(100);
      $('.hide-body').slideUp(200);
    }

    function showPopup(val) {
      $('#ov_name').text(val.file.name)
      $('.body-color').fadeIn(100);
      $('.hide-body').slideDown(200);
    }

    function toHome() {
      parent.window.location.href = 'http://jkyr.yearnedu.com/web/#/video'
    }

    function getGradeList() {
      $.ajax({
        type: "get",
        url: "/api/school/GetGrade",
        contentType: "application/json;charset=utf-8",
        dataType: "json",
        xhrFields: {
          withCredentials: true
        },
        success: function (result) {
          for (var i = 1; i < result.Content.length; i++) {
            $('#ud_grade').append("<option value =" + result.Content[i].ID + ">" + result.Content[i].GradeName +
              "</option>");
          }
        }
      });
    }

    function getCourseList() {
      $.ajax({
        type: "get",
        url: "/api/Video/GetCategeryList",
        contentType: "application/json;charset=utf-8",
        dataType: "json",
        xhrFields: {
          withCredentials: true
        },
        success: function (result) {
          for (var i = 1; i < result.Content.length; i++) {
            $('#ud_cate').append("<option value =" + result.Content[i].CateID + ">" + result.Content[i].CateName +
              "</option>");
          }
        }
      });
    }

  </script>

</body>

</html>
